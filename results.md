# Project 02: Results
**James Burke, Lucca Figlioli, Garrett Kalter**

In the process of developing our code to reproduce the results of the research paper, we devised multiple different programs and methods. In order to duplicate the results of our experiments, one must first have a recursive resolver setup that can be used to query both name servers and A records of given domains. 

## `resolver.py` Methods:
- **get_ns_records(domain)**: This function takes a domain as the parameter. It returns a list of all of the name servers of a given domain through the use of the recursive resolver provided to us in the project. If the resolver fails, we gracefully return an error message and return the function.  
- **get_ip_addresses(ns_name)**: This function takes a name server as a parameter. This method is similar to the first; however, through querying the A-record associated with each name server, we can determine each of their IP addresses. It then returns a list of all of the IP addresses for a given name server. If the resolver fails, we gracefully return an error message and return the function.  
- **query_ip_for_asn(ip_address)**: This function takes an IPv4 address as an input and determines the ASN associated with it. We use a helper function called reverse_ip to reverse the IP of the name server’s IP address. We then use Team Cymru’s IP to ASN service and use the resolver to determine the ASN associated with the name server’s IP address. If the resolver fails, we gracefully return an error message and return the function.  
- **query_asn_for_company(asn)**: Given an ASN, this function retrieves the associated company name. We once again use Team Cymru’s services to query the provided ASN parameter. We use the resolver to determine the records associated with the provided ASN and then strip all of the data but the company information from the result. We then return the company data or an error message if the query fails.  
- **process_domain(domain)**: This function takes a single domain to gather information about its NSes, the associated IP addresses, ASNs, and the company names associated with those ASNs. Initially, it obtains NS records for the domain. For each NS, it retrieves the IP addresses associated with it. Then, for each IP address, it queries the ASN and the company name. It organizes this information into a dictionary structure and returns it, with the domain as the key and information about its NS, IPs, ASNs, and company names stored in a dictionary.  
- **main(domains)**: This is the main executable program of the `resolver.py` file. It creates a dictionary which is used to store the results of all of the domains that we process. Using a ThreadPoolExecutor, we process each of the domains included within the parameter and update the results library as the threads complete. Once the threads complete, we then store the information we gathered into a JSON file for easy access and readability. This JSON file is also used to determine the percent affected and unreachable for each company.  
- **calculate_metrics_from_json(data)**: This function is responsible for analyzing the processed data stored in JSON format. It calculates two key metrics: the percentage of domains affected by each company and the percentage of domains exclusively hosted by a single company. It starts by iterating through each domain and its associated NS information in the provided data. For each domain, it identifies unique companies associated with the ASNs. Then, it counts how many domains each company affects and identifies if a domain is exclusively hosted by a single company. These counts are used to calculate the percentages of domains affected and exclusively hosted by each company, respectively. The function then returns two dictionaries that contain each AS Organization as keys and the percentage of domains that they host that are either unreachable or affected by a potential outage.
- **error handling**: When our program is unable to obtain the name servers from a domain or if it fails to obtain an IP address for a specific name server, our code gracefully handles these errors by utilizing the "try" and "except" blocks. We also add the domain or name server to a hash to keep track of which domains or NSes result in errors. This is then used at the end of running our code to obtain a total count for how many domains and how many NSes resulted in errors. We discovered that about 86 domains exist whose NSes cannot be determined and 106 NSes exist whose IPs cannot be determined.

## `run.py` and `calcResults.py`
These two files are very straightforward. `run.py` opens the provided .csv file containing our list of domains and creates a list of the first 10,000 within the list. It then runs the main executable from `resolver.py`.  
`calcResults` creates two dictionaries that contain the top 10 most popular name server hosting providers sorted by both percent affected and percent unreachable, using the information gathered from the previously created JSON file and through the use of the `calculate_metrics_from_json` method from `resolver.py`.  

## Results:
| Company             | % Affected | % Unreachable |
|---------------------|------------|---------------|
| Amazon              | 27.0       | 24.0          |
| Cloudflare          | 24.6       | 23.6          |
| Akamai              | 10.5       | 2.07          |
| Google              | 4.8        | 4.6           |
| Security Services US| 3.4        | 2.11          |
| Microsoft           | 2.4        | 1.9           |
| NSONE               | 3.8        | 1.2           |
| China UNICOM        | 1.8        | -             |
| CHINANET            | 1.7        | .02           |
| TIGGEE              | 1.6        | 1.1           |

Our results demonstrate that, since the time of this publication, the consolidation of DNS and web hosting providers has only continued to increase. Amazon and Cloudflare are now responsible for hosting the name servers of over 51% of the domains within the Tranco10k, hosting 27% and 24.6%, respectively. Our table shows the top ten most popular name server hosting providers by the percentage of domains that would be affected if their respective provider experienced an outage. We chose to do this rather than by unreachable because this method more accurately represents the top 10 name server providers. An interesting part of this table is the presence of two Chinese providers, China UNICOM and CHINANET, who both have a significant difference between their percent affected and unreachable. This may indicate that the servers that are hosted by these companies have a higher level of fault tolerance compared to their American counterparts. Additionally, we once again see a significant dropoff in hostings past Cloudflare and Amazon; however, it is less so than in the original paper, which once again supports our hypothesis of increased consolidation since this paper’s publication. 

## Bailiwick Analysis

### `bailiwick.py` Methods:
- **is_in_total_bailiwick(domain)**: Checks if a domain is in total bailiwick. It does this by resolving the NS records for the provided domain and then iterating through each name server domain. If any name server domain doesn't end with the provided domain, it's not the function that returns False. If all name servers are within the domain's namespace, it returns True.
- **is_in_partial_bailiwick(domain)**: Similar to the is_in_total_bailiwick, this function resolves the NS records for the provided domain and iterates through each name server domain. If it finds at least one name server domain that ends with the provided domain, indicating it's within the domain's namespace, the function returns True. If none of the name servers are within the domain's namespace, it returns False.
- **calculate_partial_bailiwick_percentage(domains)**: This function simply gets the percentage of domains that are partially in bailiwick.
- **calculate_total_bailiwick_percentage(domains)**: Similar to calculate_partial_bailiwick_percentage, this function is just used to find the percent of domains fully within bailiwick.

Using the above functions, we determined that 11.46% of the name servers for the domains in the Tranco10k are in total bailiwick, and 4.17% of them are in partial bailiwick meaning only a subset of their name servers fall within the domain's own namespace. These results show that very few domains keep their name servers within their own domain, and opt to outsource the job to an external organization. This can have several implications for the domains in question. Outsourcing name server management to external organizations can lead to increased reliability and performance, as these external providers often have the infrastructure, expertise, and resources to ensure high availability and security. However, this practice also introduces a dependency on third-party services, which could potentially affect the domain's autonomy and control over its DNS settings. Ultimately, these findings are in line with the consolidation of web hosting to fewer and fewer organizations, and it will be interesting to see if this trend continues with the emergence of a more decentralized internet with Web3.

- **Error Handling**: We can simply use the error handling from the above resolver function to analyze the bailiwick data because the queries are the same and will result in the same errors as the ones found in the resolver method. (Obtaining NS from domain)